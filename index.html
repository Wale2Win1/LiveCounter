<!doctype html>
<html lang="en-GB">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Live Petition Counter</title>
<meta name="description" content="Live signature counter for a UK Government petition.">
<style>
  :root{
    --bg:#0b1117; --card:#0f1722; --fg:#e7eef6; --muted:#9aa3ac;
    --accent:#005A30; --err:#ef4444; --ring:rgba(0,0,0,.28);
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#fff; --card:#f7f8fb; --fg:#111; --muted:#6a6f76; --ring:rgba(0,0,0,.08) }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:
      radial-gradient(1200px 600px at 10% -10%, color-mix(in srgb, var(--accent) 12%, transparent), transparent 60%),
      radial-gradient(1000px 600px at 120% 120%, color-mix(in srgb, var(--accent) 16%, transparent), transparent 70%),
      var(--bg);
    color:var(--fg);
    font:600 clamp(16px,2.2vw,18px)/1.25 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    display:grid;place-items:center;padding:24px;
  }
  .wrap{width:min(820px,100%);display:flex;flex-direction:column;align-items:center;gap:18px}
  .card{
    width:100%; background:linear-gradient(180deg, color-mix(in srgb, var(--card) 94%, transparent), var(--card));
    border:1px solid color-mix(in srgb, var(--accent) 14%, transparent);
    border-radius:22px; padding:clamp(16px,3vw,28px);
    box-shadow:0 12px 50px color-mix(in srgb, var(--accent) 14%, transparent), 0 10px 30px var(--ring);
    display:flex; flex-direction:column; align-items:center; gap:14px;
    position:relative; overflow:hidden;
  }

  .title{font-weight:800;text-align:center;font-size:clamp(18px,3vw,28px)}
  .counter-row{display:flex; align-items:baseline; gap:.6rem; flex-wrap:wrap; justify-content:center}
  .count{
    font-weight:900; font-size:clamp(56px,12vw,150px); line-height:.9; letter-spacing:.02em;
    text-shadow:0 0 1px color-mix(in srgb, var(--accent) 30%, transparent), 0 10px 30px color-mix(in srgb, var(--accent) 20%, transparent);
    will-change:contents,transform;
  }
  .label{font-weight:700;font-size:clamp(12px,2.4vw,20px);color:var(--muted);text-transform:uppercase;letter-spacing:.12em}

  .meta{width:100%;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;color:var(--muted);font-weight:600;font-size:clamp(12px,2.2vw,14px)}
  .pill{display:inline-flex;align-items:center;gap:.4rem;padding:.28rem .6rem;border-radius:999px;
    background: color-mix(in srgb, var(--fg) 6%, transparent); border:1px solid color-mix(in srgb, var(--fg) 10%, transparent)}
  .dot{width:.58rem;height:.58rem;border-radius:50%;background:var(--accent)}
  .live.off .dot{background:#9ca3af}

  .actions{display:flex;gap:.8rem;flex-wrap:wrap;justify-content:center}
  .btn{display:inline-flex;gap:.6rem;align-items:center;justify-content:center;border-radius:14px;padding:.68rem 1rem;
    font-weight:800; letter-spacing:.02em; background:linear-gradient(180deg,var(--accent),color-mix(in srgb, var(--accent) 86%, black 14%));
    color:#00160b; border:none; cursor:pointer; box-shadow:0 10px 24px color-mix(in srgb, var(--accent) 40%, transparent); text-decoration:none}
  .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0) scale(.99)}

  .share{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center}
  .share button{border:1px solid color-mix(in srgb, var(--fg) 10%, transparent); background:color-mix(in srgb, var(--fg) 6%, transparent);
    color:var(--fg); border-radius:10px; padding:.5rem .8rem; font-weight:700; cursor:pointer}

  .error{color:var(--err);font-weight:700;text-align:center}
  .hint{color:var(--muted);font-weight:600;text-align:center;font-size:.9em}

  .compact .count{font-size:clamp(42px,10vw,110px)}
  canvas.confetti{position:absolute; inset:0; pointer-events:none}
  @media (prefers-reduced-motion: reduce){ .btn{transition:none} }
</style>
</head>
<body>
  <div class="wrap" id="wrap">
    <div class="card" id="card">
      <canvas class="confetti" id="confetti"></canvas>

      <div class="title" id="title">Live Petition Signatures</div>

      <div class="counter-row" aria-live="polite" aria-atomic="true">
        <span class="count" id="count">–</span>
        <span class="label" id="label">signatures</span>
      </div>

      <div class="meta">
        <span class="pill live" id="live"><span class="dot"></span><span id="statusText">Live</span></span>
        <span id="updated">Fetching…</span>
        <span id="growth">+0 last hr</span>
      </div>

      <div class="actions">
        <a class="btn" id="openBtn" target="_blank" rel="noopener">Open petition</a>
      </div>

      <div class="share">
        <button id="fbBtn">Facebook</button>
        <button id="waBtn">WhatsApp</button>
        <button id="twBtn">X/Twitter</button>
        <button id="copyBtn">Copy link</button>
      </div>

      <div class="error" id="err" style="display:none"></div>
      <div class="hint" id="hint" style="display:none"></div>
    </div>
  </div>

<script>
(() => {
  /* ===== Config via URL =====
     ?id=734243&interval=30&title=Your%20Title&color=%23005A30&compact=1&proxy=https://YOURWORKER.workers.dev/?id=
  */
  const qs = new URLSearchParams(location.search);
  const petitionId = qs.get('id') || '734243';
  const intervalSec = Math.max(10, parseInt(qs.get('interval')||'30',10)||30);
  const accent = qs.get('color'); // e.g. %23005A30
  const titleParam = qs.get('title');
  const compact = qs.has('compact');
  const proxy = qs.get('proxy'); // optional, e.g. https://YOURWORKER.workers.dev/?id=
  const hidelabel = qs.has('hidelabel');
  const hidebtn = qs.has('hidebtn');
  const hideShare = qs.has('hideshare');

  const PETITION_URL = `https://petition.parliament.uk/petitions/${petitionId}`;
  const DEFAULT_ENDPOINT = `${PETITION_URL}.json`;
  const ENDPOINT = proxy
    ? (proxy.includes('{id}') ? proxy.replace('{id}', petitionId) : proxy + petitionId)
    : DEFAULT_ENDPOINT;

  /* ===== Elements ===== */
  const root = document.documentElement;
  const wrap = document.getElementById('wrap');
  const card = document.getElementById('card');
  const titleEl = document.getElementById('title');
  const countEl = document.getElementById('count');
  const labelEl = document.getElementById('label');
  const updatedEl = document.getElementById('updated');
  const growthEl = document.getElementById('growth');
  const liveEl = document.getElementById('live');
  const errEl = document.getElementById('err');
  const hintEl = document.getElementById('hint');
  const openBtn = document.getElementById('openBtn');

  if (accent) root.style.setProperty('--accent', accent);
  if (titleParam) titleEl.textContent = titleParam;
  if (compact) wrap.classList.add('compact');
  if (hidelabel) labelEl.style.display = 'none';
  if (hidebtn) openBtn.style.display = 'none';
  if (hideShare) document.querySelector('.share').style.display = 'none';
  openBtn.href = PETITION_URL;

  /* ===== State & Utils ===== */
  const nf = new Intl.NumberFormat('en-GB');
  const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  let currentValue = 0;
  let displayValue = 0;

  // localStorage samples (24h) for last-hour growth
  const LS_KEY = `petition_samples_${petitionId}`;
  const MAX_AGE_MS = 24*60*60*1000;
  function loadSamples(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); }catch{ return []; }
  }
  function saveSamples(samples){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(samples)); }catch{}
  }
  function pushSample(count){
    const now = Date.now();
    let s = loadSamples();
    s.push([now, count]);
    s = s.filter(([t]) => now - t <= MAX_AGE_MS);
    if (s.length > 300) s = s.filter((_,i) => i%2===0);
    saveSamples(s);
  }
  function getHourAgo(samples){
    const cutoff = Date.now() - 60*60*1000;
    let closest = samples[0];
    for (const p of samples) { if (p[0] <= cutoff) closest = p; else break; }
    return closest ? closest[1] : (samples[0]?.[1] || 0);
  }

  function setLive(ok){
    liveEl.classList.toggle('off', !ok);
    document.getElementById('statusText').textContent = ok ? 'Live' : 'Offline';
  }
  function showError(msg){
    errEl.style.display='block'; errEl.textContent = msg;
    hintEl.style.display='block';
    hintEl.innerHTML = 'If this keeps failing, add a proxy and reload with<br><code>?proxy=https://YOURWORKER.workers.dev/?id=</code><br>or<br><code>?proxy=https://YOURWORKER.workers.dev/petition/{id}</code>';
  }
  function hideError(){ errEl.style.display='none'; hintEl.style.display='none'; }

  /* ===== Animated number ===== */
  function easeOutExpo(t){ return t>=1 ? 1 : 1 - Math.pow(2, -10*t); }
  function animateTo(target, ms=900){
    if (prefersReducedMotion){ countEl.textContent = nf.format(target); displayValue = target; return; }
    const start = performance.now();
    const from = displayValue;
    const delta = target - from;
    function frame(now){
      const t = Math.min((now - start)/ms, 1);
      displayValue = from + delta * easeOutExpo(t);
      countEl.textContent = nf.format(Math.round(displayValue));
      if (t<1) requestAnimationFrame(frame); else displayValue = target;
    }
    requestAnimationFrame(frame);
    countEl.animate([{transform:'scale(1.00)'},{transform:'scale(1.03)'},{transform:'scale(1.00)'}],
                    {duration:450,easing:'cubic-bezier(.2,.8,.2,1)'});
  }

  /* ===== Confetti ===== */
  const confetti = (() => {
    const canvas = document.getElementById('confetti');
    const ctx = canvas.getContext('2d');
    let particles=[], running=false;
    function resize(){ canvas.width = card.clientWidth; canvas.height = card.clientHeight; }
    window.addEventListener('resize', resize); resize();
    function burst(count=160){
      if (prefersReducedMotion) return;
      for(let i=0;i<count;i++){
        particles.push({
          x: Math.random()*canvas.width,
          y: -10,
          vx: (Math.random()-0.5)*2.6,
          vy: Math.random()*2 + 2,
          size: Math.random()*4 + 2,
          rot: Math.random()*Math.PI,
          vr: (Math.random()-0.5)*0.2,
          hue: (Math.random()*30 - 15) + 150,
          life: Math.random()*120 + 120
        });
      }
      if(!running){ running=true; loop(); }
    }
    function loop(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      particles = particles.filter(p=>p.life>0);
      for(const p of particles){
        p.x+=p.vx; p.y+=p.vy; p.vy+=0.02; p.rot+=p.vr; p.life--;
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot);
        ctx.fillStyle = `hsl(${p.hue},80%,60%)`; ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size); ctx.restore();
      }
      if(particles.length) requestAnimationFrame(loop); else running=false;
    }
    return { burst };
  })();

  /* ===== Networking ===== */
  async function fetchOnce(url){
    const res = await fetch(url, { cache:'no-store' });
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const j = await res.json();
    const n = j?.data?.attributes?.signature_count;
    if(typeof n !== 'number') throw new Error('signature_count missing');
    return n;
  }
  async function fetchCount(){
    try{
      return await fetchOnce(ENDPOINT);
    }catch(e){
      if (proxy && !ENDPOINT.startsWith(proxy)){
        try{ return await fetchOnce(proxy.includes('{id}') ? proxy.replace('{id}', petitionId) : proxy + petitionId); }
        catch { throw e; }
      }
      throw e;
    }
  }

  function updateUI(n){
    const now = new Date();
    updatedEl.textContent = 'Updated ' + now.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});

    pushSample(n);
    const samples = loadSamples();
    const hourAgo = getHourAgo(samples);
    const deltaHour = Math.max(0, n - hourAgo);
    growthEl.textContent = `+${new Intl.NumberFormat('en-GB').format(deltaHour)} last hr`;

    if(n !== currentValue){
      if (Math.floor(n/1000) > Math.floor(currentValue/1000) && currentValue>0) confetti.burst(180);
      currentValue = n;
      animateTo(n);
    }

    hideError(); setLive(true);
  }

  let delay = intervalSec*1000;
  function setLive(ok){ liveEl.classList.toggle('off', !ok); document.getElementById('statusText').textContent = ok ? 'Live' : 'Offline'; }
  function scheduleNext(ok){ delay = ok ? intervalSec*1000 : Math.min(delay*2, 300000); setTimeout(tick, delay); }

  async function tick(){
    try{ const n = await fetchCount(); updateUI(n); scheduleNext(true); }
    catch(e){ console.error(e); setLive(false); showError('Update failed: ' + (e?.message || e)); scheduleNext(false); }
  }

  // Init
  if (titleParam) { titleEl.textContent = titleParam; document.title = titleParam; }
  openBtn.href = PETITION_URL;
  tick();

  /* ===== Share buttons ===== */
  const url = PETITION_URL;
  document.getElementById('fbBtn').onclick = () =>
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`,'_blank');
  document.getElementById('waBtn').onclick = () =>
    window.open(`https://wa.me/?text=${encodeURIComponent('Please sign: ' + url)}`,'_blank');
  document.getElementById('twBtn').onclick = () =>
    window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent('Please sign this petition')}`,'_blank');
  document.getElementById('copyBtn').onclick = () =>
    navigator.clipboard.writeText(url).then(()=>alert('Link copied!'));
})();
</script>
</body>
</html>
